{% extends "layout.html" %}
{% block content %}
<h2>Admin Dashboard</h2>
<div class="admin-actions">
  <a class="btn" href="{{ url_for('admin_add') }}">+ Add Product</a>
</div>

<table class="admin-table">
  <thead><tr><th>ID</th><th>Image</th><th>Name</th><th>Price</th><th>Actions</th></tr></thead>
  <tbody>
  {% for p in products %}
    <tr id="row-{{ p.id }}">
      <td>{{ p.id }}</td>
      <td><img class="thumb" src="{{ p.image_url() }}"></td>
      <td><input class="inline-input name-input" data-id="{{ p.id }}" value="{{ p.name }}"></td>
      <td><input class="inline-input price-input" data-id="{{ p.id }}" value="{{ p.price }}"></td>
      <td>
        <a href="{{ url_for('admin_edit', pid=p.id) }}" class="btn small">Edit</a>
        <form action="{{ url_for('admin_delete', pid=p.id) }}" method="post" style="display:inline" onsubmit="return confirm('Delete?')">
          <button class="btn small danger" type="submit">Delete</button>
        </form>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const sendUpdate = (id, data) => {
    fetch('/api/update_product/' + id, {
      method: 'POST',
      body: new URLSearchParams(data),
      credentials: 'same-origin'
    }).then(r=>r.json()).then(res=>{
      if(res.status === 'ok'){
        const card = document.querySelector('#product-' + id);
        if(card){
          if(data.name !== undefined) card.querySelector('.pname').textContent = data.name;
          if(data.price !== undefined) card.querySelector('.price').textContent = 'â‚¹ ' + data.price;
          if(data.description !== undefined) card.querySelector('.pdesc').textContent = data.description;
        }
      } else {
        alert('Update failed');
      }
    });
  };

  document.querySelectorAll('.name-input').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const id = e.target.dataset.id;
      sendUpdate(id, {name: e.target.value});
    });
  });
  document.querySelectorAll('.price-input').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const id = e.target.dataset.id;
      sendUpdate(id, {price: e.target.value});
    });
  });
});
</script>
{% endblock %}
